service: customers-api

plugins:
  - serverless-esbuild
  - serverless-offline

provider:
  name: aws
  runtime: nodejs18.x
  region: us-west-1
  stage: ${opt:stage}
  logRetentionInDays: 180
  versionFunctions: false
  timeout: 30
  environment:
    STAGE: ${self:provider.stage}

custom:
  prefix: ${self:service}-${self:provider.stage}
  lambdaUrl: localhost:3000/api

functions:
  GetAll:
    handler: ./src/get-all/handler.handler
    role: FunctionRole
    events:
      - httpApi:
          path: /api
          method: GET

  BulkCreate:
    handler: ./src/bulk-create/handler.handler
    role: FunctionRole
    events:
      - httpApi:
          path: /api
          method: POST

  Simulator:
    handler: ./src/simulator/handler.handler
    role: FunctionRole
    events:
      - httpApi:
          path: /api/simulator
          method: POST
    environment:
      LAMBDA_URL: ${self:custom.lambdaUrl}

resources:
  Resources:
    FunctionRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal:
                Service: lambda.amazonaws.com
              Action: sts:AssumeRole
        ManagedPolicyArns:
          - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        Policies:
          - PolicyName: ${self:custom.prefix}-FunctionRole-policy
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action: 
                    - "sqs:*"
                  Resource: "*"
                - Effect: Allow
                  Action: 
                    - "dynamodb:GetItem"
                    - "dynamodb:PutItem"
                  Resource: 
                    - !GetAtt CustomersTable.Arn
    CustomersTable:
      Type: "AWS::DynamoDB::Table"
      Properties:
        TableName: customers
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
